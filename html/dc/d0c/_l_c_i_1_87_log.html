<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LCI: Development log for LCI v1.7</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">LCI
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('dc/d0c/_l_c_i_1_87_log.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Development log for LCI v1.7 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>New in v1.7</h2>
<ul>
<li>new API (especially for memory registration and iovec)</li>
<li>test infrastructure</li>
</ul>
<h2>Decisions to be made</h2>
<ul>
<li><code>const</code> or <code>#define</code> or <code>enum</code>: which to use? Libfabric, MPICH, and Argobots both use <code>#define</code>. Why?</li>
<li>The immediate data for libibverbs has only 32 bits. It remains unknown how to pass a handle to a completion object in remote memory.</li>
</ul>
<h3>Design</h3>
<h4>LCII_context_t</h4>
<p>Asynchronous operations of Low-level communication engine use a 64-bit <code>context</code> to pass information between the initialization and completion phases. For example, if you want to send a message with Libfabric, you can call <code>fi_send</code> </p><div class="fragment"><div class="line">ssize_t fi_send(<span class="keyword">struct</span> fid_ep *ep, <span class="keyword">const</span> <span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> len,</div>
<div class="line">        <span class="keywordtype">void</span> *desc, fi_addr_t dest_addr, <span class="keywordtype">void</span> *context);</div>
</div><!-- fragment --><p>to initialize a send operation. Then, you will poll the completion queue with <code>fi_cq_read</code>. </p><div class="fragment"><div class="line">ssize_t fi_cq_read(<span class="keyword">struct</span> fid_cq *cq, <span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> count);</div>
</div><!-- fragment --><p>After a while, you will get a entry from the completion queue, such as <code>fi_cq_tagged_entry</code>. </p><div class="fragment"><div class="line"><span class="keyword">struct </span>fi_cq_tagged_entry {</div>
<div class="line">    <span class="keywordtype">void</span>     *op_context; <span class="comment">/* operation context */</span></div>
<div class="line">    uint64_t flags;       <span class="comment">/* completion flags */</span></div>
<div class="line">    <span class="keywordtype">size_t</span>   len;         <span class="comment">/* size of received data */</span></div>
<div class="line">    <span class="keywordtype">void</span>     *buf;        <span class="comment">/* receive data buffer */</span></div>
<div class="line">    uint64_t data;        <span class="comment">/* completion data */</span></div>
<div class="line">    uint64_t tag;         <span class="comment">/* received tag */</span></div>
<div class="line">};</div>
</div><!-- fragment --><p>This entry indicate one of your previously issued asynchronous operations has been completed. (For <code>fi_send</code>, this means it has been completed locally.) Usually, we want to do something when an operation is completed, for example, we want to return the message buffer to the buffer pool, so we need to know the buffer address. However, in Libfabric, we cannot always get the processed buffer address from the completion entry.</p>
<blockquote class="doxtable">
<p>(<a href="https://ofiwg.github.io/libfabric/v1.11.2/man/fi_cq.3.html">https://ofiwg.github.io/libfabric/v1.11.2/man/fi_cq.3.html</a>) The buf field is only valid for completed receive operations, and only applies when the receive buffer was posted with the FI_MULTI_RECV flag. In this case, buf points to the starting location where the receive data was placed. </p>
</blockquote>
<p>As a result, we need to pass some additional information from the operation initialization phase to the operation completion phase. We could do this through the <code>op_context</code> field.</p>
<blockquote class="doxtable">
<p>The operation context is the application specified context value that was provided with an asynchronous operation. The op_context field is valid for all completions that are associated with an asynchronous operation. For completion events that are not associated with a posted operation, this field will be set to NULL. This includes completions generated at the target in response to RMA write operations that carry CQ data (FI_REMOTE_WRITE | FI_REMOTE_CQ_DATA flags set), when the FI_RX_CQ_DATA mode bit is not required. </p>
</blockquote>
<p>The <code>op_context</code> field has 64 bits. How much information do we need to pass throw this field? Absolutely more than 64 bits. At least for local completion of send, we need the buffer address and the buffer type, which needs at least 65 bits.</p>
<p>As a result, we need a <code>LCII_context_t</code> object that contains the information we need, and pass the address of this object in the <code>op_context</code> field. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
